<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>运维相关（生产BUG）</title>
    <link href="/my-blog/2023/11/01/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    <url>/my-blog/2023/11/01/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br>数据库备份还原<br>mysqldump <span class="hljs-operator">-</span>h192<span class="hljs-number">.168</span><span class="hljs-number">.7</span><span class="hljs-number">.55</span> <span class="hljs-operator">-</span>P13306 <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p srm_prod <span class="hljs-comment">--set-gtid-purged=off &gt;/home/srm_prod20230908.sql</span><br><br>scp <span class="hljs-operator">/</span>home<span class="hljs-operator">/</span>srm_prod20230908.sql root<span class="hljs-variable">@192</span><span class="hljs-number">.168</span><span class="hljs-number">.7</span><span class="hljs-number">.52</span>:<span class="hljs-operator">/</span>home<span class="hljs-operator">/</span>srm_prod20230908.sql<br><br><br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p srm_prod20230808 <span class="hljs-operator">&lt;</span> <span class="hljs-operator">/</span>home<span class="hljs-operator">/</span>srm_prod20230908.sql<br></code></pre></td></tr></table></figure><h3 id="JS记录"><a href="#JS记录" class="headerlink" title="JS记录"></a>JS记录</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">去除小数点多余的<span class="hljs-number">0</span>：<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/0*$|\.0*$/</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">1、流程节点设置<br></code></pre></td></tr></table></figure><h4 id="BinLog-日志还原"><a href="#BinLog-日志还原" class="headerlink" title="BinLog 日志还原"></a>BinLog 日志还原</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">cd <span class="hljs-operator">/</span>opt<span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>mysqldata  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>  对应binlog日志存放<br><br><span class="hljs-number">606082443</span><br>mysqlbinlog <span class="hljs-comment">--no-defaults -v -v --base64-output=decode-rows mysql-bin.000043 | sed -n &#x27;/# at 606082443/,/COMMIT/p&#x27; &gt; tbl_data.txt</span><br><br>[root<span class="hljs-variable">@db01</span> data]# sed <span class="hljs-string">&#x27;/WHERE/&#123;:a;N;/SET/!ba;s/\([^\n]*\)\n\(.*\)\n\(.*\)/\3\n\2\n\1/&#125;&#x27;</span> tbl_data.txt <span class="hljs-operator">|</span> sed <span class="hljs-operator">-</span>r <span class="hljs-string">&#x27;/WHERE/&#123;:a;N;/@3/!ba;s/###   @2.*//g&#125;&#x27;</span> <span class="hljs-operator">|</span> sed <span class="hljs-string">&#x27;s/### //g;s/\/\*.*/,/g&#x27;</span> <span class="hljs-operator">|</span> sed <span class="hljs-string">&#x27;/WHERE/&#123;:a;N;/@19/!ba;s/,/;/g&#125;;s/#.*//g;s/COMMIT,//g&#x27;</span> <span class="hljs-operator">|</span> sed <span class="hljs-string">&#x27;/^$/d&#x27;</span> <span class="hljs-operator">&gt;</span> recovery.sql<br>sed <span class="hljs-operator">-</span>n <span class="hljs-string">&#x27;/### UPDATE /,/### SET /p&#x27;</span> tbl_data.txt <span class="hljs-operator">|</span><br>sed <span class="hljs-operator">-</span>n <span class="hljs-string">&#x27;/@3\|@19/p&#x27;</span> <span class="hljs-operator">|</span><br>sed <span class="hljs-operator">-</span>r <span class="hljs-string">&#x27;s/.*@3=([^ ]*).*@\d+=&#x27;&#x27;\&#x27;&#x27;([^&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>]<span class="hljs-operator">*</span>)<span class="hljs-string">&#x27;&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>.<span class="hljs-operator">*</span><span class="hljs-operator">/</span><span class="hljs-keyword">UPDATE</span> `srm_prod`.`price_tpl_pt0075_b` <span class="hljs-keyword">set</span> os514 <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\1&#x27;</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\2&#x27;</span><span class="hljs-operator">/</span>g<span class="hljs-string">&#x27; &gt; recovery.sql</span><br><span class="hljs-string"></span><br><span class="hljs-string">sed -n &#x27;</span><span class="hljs-operator">/</span>### <span class="hljs-keyword">UPDATE</span> <span class="hljs-operator">/</span>,<span class="hljs-operator">/</span>### <span class="hljs-keyword">SET</span> <span class="hljs-operator">/</span>p<span class="hljs-string">&#x27; tbl_data.txt |</span><br><span class="hljs-string">sed -n &#x27;</span><span class="hljs-operator">/</span><span class="hljs-variable">@3</span>\<span class="hljs-operator">|</span><span class="hljs-variable">@19</span><span class="hljs-operator">/</span>p<span class="hljs-string">&#x27; |</span><br><span class="hljs-string">sed -r &#x27;</span>s<span class="hljs-operator">/</span><span class="hljs-operator">^</span>(.<span class="hljs-operator">*</span>)<span class="hljs-variable">@3</span><span class="hljs-operator">=</span>([<span class="hljs-operator">^</span> ]<span class="hljs-operator">*</span>).<span class="hljs-operator">*</span><span class="hljs-variable">@19</span><span class="hljs-operator">=</span>\<span class="hljs-string">&#x27;\&#x27;&#x27;([^&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>]<span class="hljs-operator">*</span>)<span class="hljs-string">&#x27;\&#x27;&#x27;.*$/\1UPDATE `\`srm_prod\`.\`price_tpl_pt0075_b\` set os514 = &#x27;</span>\<span class="hljs-number">2</span><span class="hljs-string">&#x27; WHERE id = &#x27;</span>\<span class="hljs-number">3</span><span class="hljs-string">&#x27;\\n/g&#x27;</span> <span class="hljs-operator">&gt;</span> recovery2.sql<br><br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">show</span> processlist;<br>kill <span class="hljs-number">150436</span><br><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">where</span> In_use &gt; <span class="hljs-number">0</span>;<br><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;<br><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS;<br><br><br><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;<br></code></pre></td></tr></table></figure><h4 id="数据库备份还原"><a href="#数据库备份还原" class="headerlink" title="数据库备份还原"></a>数据库备份还原</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1</span> 进入数据库存放的具体位置   /var/lib/mysql/<br><span class="hljs-number">2</span> 备份   mysqldump -uroot -p 目标数据库名称 &gt; /home/bak/备份脚本名称.<span class="hljs-keyword">sql</span><br><span class="hljs-number">3</span> 跨机迁移数据 scp /home/bak/目标脚本.<span class="hljs-keyword">sql</span> root@迁移地址:/home/bak/迁移后脚本.<span class="hljs-keyword">sql</span><br><span class="hljs-number">4</span> 手动新建一个数据库<br><span class="hljs-number">5</span> 还原 mysql -uroot -p 手动新建的数据库 &lt; /home/bak/迁移后脚本.<span class="hljs-keyword">sql</span><br><span class="hljs-number">6</span> 远程连接 mysql -h <span class="hljs-number">192.168</span><span class="hljs-number">.7</span><span class="hljs-number">.55</span> -uroot -pSrm@<span class="hljs-number">8517</span> -P13306<br><br>数据库用户创建权限设置<br><span class="hljs-comment">-- 创建用户</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.7.79&#x27;</span>,<span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;td_guest01&#x27;</span>;<br><span class="hljs-comment">-- 给表只读权限</span><br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> srm_prod.production_return_repair <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.7.79&#x27;</span>,<span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span>;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> srm_prod.back_repair_send <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.7.79&#x27;</span>,<span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span>;<br><span class="hljs-comment">-- 刷新权限</span><br>FLUSH <span class="hljs-keyword">PRIVILEGES</span>;<br><span class="hljs-comment">-- 取回权限</span><br><span class="hljs-keyword">REVOKE</span> privilege <span class="hljs-keyword">ON</span> srm_prod20230523.back_repair_send <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span>;<br><span class="hljs-comment">-- 查询用户</span><br><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">from</span> mysql.<span class="hljs-keyword">user</span>;<br><span class="hljs-comment">-- 取回所有权限针对某个账号</span><br><span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span>, <span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">OPTION</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span>;<br><span class="hljs-comment">-- 展示账号的权限</span><br><span class="hljs-keyword">SHOW</span> GRANTS <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.17.5&#x27;</span>;<br><span class="hljs-comment">-- 删除用户</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;guest01&#x27;</span>@<span class="hljs-string">&#x27;192.168.7.79&#x27;</span>; <br></code></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stata">jdbc:mysql:<span class="hljs-comment">//192.168.7.55:13306/srm_prod?characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>root<br><br>com.zaxxer.hikari.HikariDataSource<br><br>yum install <span class="hljs-keyword">zip</span> -y<br><span class="hljs-keyword">zip</span> -r zheap0726.<span class="hljs-keyword">zip</span> zheap_localhost.localdomain_20230726150257.hprof<br>docker cp :/logs/zheap0.<span class="hljs-keyword">zip</span> /home<br><br><br>nginx<br><br>awk &#x27;&#123;<span class="hljs-keyword">split</span>(<span class="hljs-variable">$4</span>,array,<span class="hljs-string">&quot;[&quot;</span>);<span class="hljs-keyword">if</span>(array[2]&gt;=<span class="hljs-string">&quot;26/Jul/2023:16:20:05&quot;</span> &amp;&amp; array[2]&lt;=<span class="hljs-string">&quot;26/Jul/2023:16:27:05&quot;</span>)&#123;<span class="hljs-keyword">print</span> <span class="hljs-variable">$0&#125;</span>&#125;&#x27; access.<span class="hljs-keyword">log</span><br><br></code></pre></td></tr></table></figure><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-number">55</span>服务器<br>ps -ef | <span class="hljs-keyword">grep</span> activemq<br>netstat -antup | <span class="hljs-keyword">grep</span> <span class="hljs-number">61616</span> <br>firewall-cmd --zone=<span class="hljs-keyword">public</span> --add-port=<span class="hljs-number">8161</span>/tcp --permanent<br>firewall-cmd --zone=<span class="hljs-keyword">public</span> --add-port=<span class="hljs-number">61616</span>/tcp --permanent<br><span class="hljs-regexp">/root/</span>activeMQ<span class="hljs-regexp">/apache-activemq-5.14.5/</span>bin<br>./activemq start<br><br>挂载nfs<br><span class="hljs-number">54</span> <span class="hljs-number">53</span>分别挂载到<span class="hljs-number">55</span><br>mount -t nfs <span class="hljs-number">192.168</span>.<span class="hljs-number">7.55</span>:<span class="hljs-regexp">/nfsshare /</span>app<span class="hljs-regexp">/tsrm/</span>jenkinsPackage<br><br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">服务器停机处理<br>分别进入srm前端、sip前端容器  docker exec -it xxx <span class="hljs-keyword">sh</span><br><span class="hljs-keyword">cd</span> /etc/nginx/<span class="hljs-keyword">conf</span>.d<br><span class="hljs-keyword">vi</span> default.xxx   修改location地址为对应的后端地址  保存后 nginx -s reload <br></code></pre></td></tr></table></figure><h4 id="CPU飙升排查"><a href="#CPU飙升排查" class="headerlink" title="CPU飙升排查"></a>CPU飙升排查</h4><p>top -H -p 9  查看CPU占用高的具体线程，发现耗CPU的线程都是比较小的PID，根据经验可知应该是GC的问题</p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230605135218278.png" alt="image-20230605135218278"></p><h4 id="jmap-histo-9-head-20-前20堆栈查看有没有明显错误"><a href="#jmap-histo-9-head-20-前20堆栈查看有没有明显错误" class="headerlink" title="jmap -histo 9 | head -20  前20堆栈查看有没有明显错误"></a>jmap -histo 9 | head -20  前20堆栈查看有没有明显错误</h4><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230605135357623.png" alt="image-20230605135357623"></p><h4 id="jmap-heap-9-查看gc情况"><a href="#jmap-heap-9-查看gc情况" class="headerlink" title="jmap -heap 9 查看gc情况"></a>jmap -heap 9 查看gc情况</h4><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230605135423240.png" alt="image-20230605135423240"></p><h5 id="下载dump日志进一步分析"><a href="#下载dump日志进一步分析" class="headerlink" title="下载dump日志进一步分析"></a>下载dump日志进一步分析</h5><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">jmap -dump:format=b,file=<span class="hljs-regexp">/logs/</span>zheap_$(hostname)_$(<span class="hljs-built_in">date</span> +<span class="hljs-string">&quot;%Y%m%d%H%M%S&quot;</span>).hprof <span class="hljs-number">9</span><br>jstack -F -m <span class="hljs-number">9</span> &gt;&gt; <span class="hljs-regexp">/logs/</span>zjstack_$(hostname)_$(<span class="hljs-built_in">date</span> +<span class="hljs-string">&quot;%Y%m%d%H%M%S&quot;</span>).<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><h5 id="分析结果"><a href="#分析结果" class="headerlink" title="分析结果"></a>分析结果</h5><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16859459636069.png" alt="img"></p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16859470992276.png" alt="img"></p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16859470879029.png" alt="img" style="zoom: 50%;" /><p>判断是由于用户使用了合同明细的导出功能导致GC异常从而导致CPU飙升至1000%</p><h3 id="CPU飙升排查2"><a href="#CPU飙升排查2" class="headerlink" title="CPU飙升排查2"></a>CPU飙升排查2</h3><h5 id="下载dump日志进行分析"><a href="#下载dump日志进行分析" class="headerlink" title="下载dump日志进行分析"></a>下载dump日志进行分析</h5><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230616110747670.png" alt="image-20230616110747670"></p><p>发现问题出现在groovy代码块中，继续排查</p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230616110940883.png" alt="image-20230616110940883"></p><p>发现与订单的查询sql语句有关，继续排查</p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16868828363055.png" alt="img"></p><p>找到具体代码块6D5E578AA665F1518A6C，确认是新增/编辑单个入库单接口前-校验入库单信息代码块的问题</p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230616111434032.png" alt="image-20230616111434032"></p><p>增加判空处理</p><h3 id="CPU飙升排查3"><a href="#CPU飙升排查3" class="headerlink" title="CPU飙升排查3"></a>CPU飙升排查3</h3><p>下载dump日志分析</p><p><img src="https://gilimall-xae.oss-cn-hangzhou.aliyuncs.com/blog_typora/image-20230703161800596.png" alt="image-20230703161800596"></p><p><img src="C:\Users\19069\AppData\Roaming\Typora\typora-user-images\image-20230703161818129.png" alt="image-20230703161818129"></p><p>结合实际操作情况判断是订单报表导出导致的CPU飙升宕机</p>]]></content>
    
    
    <categories>
      
      <category>后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>works</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
